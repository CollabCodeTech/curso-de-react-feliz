## 05 - Adiciona Husky e o lint-staged

Vamos ver o lint-staged e o Husky.

A ideia e fazer que o código não vá para o repositório com código "ruim" o que seria isso é o código ir sem ser validado por alguma ferramenta.

### Tarefas

1. Instalar o Husky e o lint-staged;

### Passo a passo

#### 1. Instalar o Husky

Primeiro vamos instalar o [Husky](https://github.com/typicode/husky), que é uma ferramenta para nos auxiliar na configuração do Git Hooks, que é um anjou, as ações que fazermos no git, como commit, merge, push que iremos chamar agora de eventos, nós podemos interceptar a execução destes eventos antes, durante ou depois que eles acontecem, para executar tarefas de forma automatizada.

No terminal na pasta do projeto **chatcollab** se executarmos o comando a baixo

```bash
~/Desktop/chatcollab$ la -las
total 188
drwxr-xr-x   5  marcobruno  ...  4096 Feb 23 17:17 ./
drwxr-xr-x   3  marcobruno  ...  4096 Feb 23 16:33 ../
-rw-r--r--   1  marcobruno  ...   365 Feb 23 17:02 .eslintrc.json
-rw-r--r--   1  marcobruno  ...   253 Feb 23 15:58 .gitignore
-rw-r--r--   1  marcobruno  ...   364 Feb 23 15:58 index.html
drwxr-xr-x 196  marcobruno  ... 12288 Feb 23 17:17 node_modules/
-rw-r--r--   1  marcobruno  ... 59626 Feb 23 17:02 package-lock.json
-rw-r--r--   1  marcobruno  ...   617 Feb 23 17:17 package.json
drwxr-xr-x   2  marcobruno  ...  4096 Feb 23 15:58 src/
-rw-r--r--   1  marcobruno  ...   162 Feb 23 15:58 vite.config.js
-rw-r--r--   1  marcobruno  ... 85011 Feb 23 17:17 yarn.lock
```

Ops não temos nada, porque ainda não iniciamos o git do nosso projeto. Para isso vamos executar o comando `git init` agora se dermos o comando `ls -las` novamente temos

```bash
~/Desktop/chatcollab$ la -las
total 192
drwxr-xr-x   5  marcobruno  ...  4096 Feb 23 17:17 ./
drwxr-xr-x   3  marcobruno  ...  4096 Feb 23 16:33 ../
-rw-r--r--   1  marcobruno  ...   365 Feb 23 17:02 .eslintrc.json
drwxr-xr-x   7  marcobruno  ...  4096 Feb 23 16:57 .git/
-rw-r--r--   1  marcobruno  ...   253 Feb 23 15:58 .gitignore
-rw-r--r--   1  marcobruno  ...   364 Feb 23 15:58 index.html
drwxr-xr-x 196  marcobruno  ... 12288 Feb 23 17:17 node_modules/
-rw-r--r--   1  marcobruno  ... 59626 Feb 23 17:02 package-lock.json
-rw-r--r--   1  marcobruno  ...   617 Feb 23 17:17 package.json
drwxr-xr-x   2  marcobruno  ...  4096 Feb 23 15:58 src/
-rw-r--r--   1  marcobruno  ...   162 Feb 23 15:58 vite.config.js
-rw-r--r--   1  marcobruno  ... 85011 Feb 23 17:17 yarn.lock
```

Agora sim termos a pasta .git, agora dentro dele vamos encontrar a pasta hooks que tem todos os exemplos de código para interceptarmos os eventos.

```bash
~/Desktop/chatcollab$ cd .git
~/Desktop/chatcollab/.git$ cd hooks
~/Desktop/chatcollab/.git/hooks$ ls
total 60
drwxr-xr-x 2 marcobruno ... 4096 Mar  8 13:55 ./
drwxr-xr-x 7 marcobruno ... 4096 Mar  8 13:55 ../
-rwxr-xr-x 1 marcobruno ...  478 Mar  8 13:55 applypatch-msg.sample*
-rwxr-xr-x 1 marcobruno ...  896 Mar  8 13:55 commit-msg.sample*
-rwxr-xr-x 1 marcobruno ... 3079 Mar  8 13:55 fsmonitor-watchman.sample*
-rwxr-xr-x 1 marcobruno ...  189 Mar  8 13:55 post-update.sample*
-rwxr-xr-x 1 marcobruno ...  424 Mar  8 13:55 pre-applypatch.sample*
-rwxr-xr-x 1 marcobruno ... 1638 Mar  8 13:55 pre-commit.sample*
-rwxr-xr-x 1 marcobruno ...  416 Mar  8 13:55 pre-merge-commit.sample*
-rwxr-xr-x 1 marcobruno ... 1348 Mar  8 13:55 pre-push.sample*
-rwxr-xr-x 1 marcobruno ... 4898 Mar  8 13:55 pre-rebase.sample*
-rwxr-xr-x 1 marcobruno ...  544 Mar  8 13:55 pre-receive.sample*
-rwxr-xr-x 1 marcobruno ... 1492 Mar  8 13:55 prepare-commit-msg.sample*
-rwxr-xr-x 1 marcobruno ... 3610 Mar  8 13:55 update.sample*
```

> Os arquivos terminal com a extensão sample por serem exemplos. Eles não são executados enquanto estiverem com esta extensão.

O [lint-staged](https://github.com/okonet/lint-staged) que será utilizado junto com o Husky é uma ferramenta que garante que o nosso código está em conformidade com os padrões que configuramos no Eslint e Prettier

O comando `npx mrm@2 lint-staged` já instalará as duas ferramentas para nossa felicidade.

> O npx vai baixar o mrm na versão dois vai instalar o lint-staged e depois vai apagar o mrm, ou seja, ele baixa um pacote para ser utilizado mas ele não armazena no nosso computador.

```bash
~/Desktop/chatcollab$ npx mrm@2 lint-staged
npx: installed 237 in 32.694s
Running lint-staged...
Update package.json
Installing lint-staged and husky...
yarn add v1.22.17
warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[1/4] Resolving packages...
[2/4] Fetching packages...
error @vitejs/plugin-react@1.2.0: The engine "node" is incompatible with this module. Expected version ">=12.0.0". Got "10.19.0"
error Found incompatible module.
info Visit https://yarnpkg.com/en/docs/cli/add for documentation about this command.
husky - Git hooks installed
husky - created .husky/pre-commit
```

> Quando terminar o processo de instalação vermos que foi criado uma pasta _*oculta*_ chamada `.husky` com todas as configurações do Husky, se você tiver em um projeto com a versão do Husky antiga, algum projeto legado, as configurações podem estar junto com o package.json, isso não é muito bom, tente atualizar o seu Husky neste projeto.

Vamos simular o nosso primeiro commit para verificar se já está tudo funcionando corretamente.

```bash
~/Desktop/chatcollab$ git status
On branch main

No commits yet

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        .eslintrc.json
        .gitignore
        .husky/
        index.html
        package-lock.json
        package.json
        src/
        vite.config.js
        yarn.lock

nothing added to commit but untracked files present (use "git add" to track)

~/Desktop/chatcollab$ git add .

~/Desktop/chatcollab$ git status
On branch main

No commits yet

Changes to be committed:
  (use "git rm --cached <file>..." to unstage)
        new file:   .eslintrc.json
        new file:   .gitignore
        new file:   .husky/.gitignore
        new file:   .husky/pre-commit
        new file:   index.html
        new file:   package-lock.json
        new file:   package.json
        new file:   src/App.css
        new file:   src/App.jsx
        new file:   src/favicon.svg
        new file:   src/index.css
        new file:   src/logo.svg
        new file:   src/main.jsx
        new file:   vite.config.js
        new file:   yarn.lock

~/Desktop/chatcollab$ git commit -m "First commit"
⚠️ Skipping backup because there's no initial commit yet.

✔ Preparing lint-staged...

⚠️ Running tasks for staged files...
	> package.json - 16 files
		> *.js - 1 file
			x eslint --cache --fix [FAILED]

✔ Applying modifications from tasks...

x eslint --cache --fix:

/Users/marcobruno/Desktop/chatcollab/vite.config.js
1:1	error	'vite' shold be listed in the projetc´s dependencies, \
 not devDependencies

2:1	error	'@vitejs/plugin-react' should be listed in the project´s \
 dependencies, not devDependencies

x 2 problems (2 errors, 0 warnings)

husky - pre-commit hook exited with code 1 (error)

```

Porque tivemos este problema, é que este arquivo vite.config.js é um arquivo de configuração, e o Eslint não pode validar isso, então devamos fazer o seguinte:

Criar o arquivo `.eslintignore` na raiz do projeto.

```bash
~/Desktop/chatcollab$ touch .eslintignore
```

E colocar o nome do arquivo de configuração dentro dele.

```bash
~/Desktop/chatcollab$ cat .eslintignore
vite.config.js

```

> É de suma importancia que você entende que só pode colocar arquivos aqui de configuração, não é para a cada erro colocar o nome do arquivo no `.eslintignore`.

Agora podemos dar um git status

```bash
~/Desktop/chatcollab$ git status
On branch main

No commits yet

Changes to be committed:
  (use "git rm --cached <file>..." to unstage)
        new file:   .eslintrc.json
        new file:   .gitignore
        new file:   .husky/.gitignore
        new file:   .husky/pre-commit
        new file:   index.html
        new file:   package-lock.json
        new file:   package.json
        new file:   src/App.css
        new file:   src/App.jsx
        new file:   src/favicon.svg
        new file:   src/index.css
        new file:   src/logo.svg
        new file:   src/main.jsx
        new file:   vite.config.js
        new file:   yarn.lock

Untrack files:
        .eslintcache
        .eslintignore

```

> Repare que ainda não foi comitado.

Executamos o `git add .` para adicionaro nosso _.eslintignore_ e depois podemos dar o `git commit -m "First commit"`

Vemos que agora sim o Eslint rodou sem erros e garantimos que todos os arquivos que serão comitados estão seguindo o padrão que definimos no projeto.
